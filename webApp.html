<html>
    <head>
        <meta charset="utf-8"/>
        <meta name = "viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
        <title> Intern Bridge QAQC WebApp</title>

        <!-- SET ESRI CSS SOURCE -->
        <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css"/>
        
        <!-- SET ESRI JS API SOURCE -->
        <script src="https://js.arcgis.com/4.26/"></script>
        
        <!-- CSS IN A STYLE TAG -->
        <style>
            html,
            body 
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
                float: right;
            }

            #sidebar {
                z-index: 99;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 400px;
                background: rgba(0, 0, 0, 0.5);
            }

            #text {
                color: white;
                padding: 3%;
            }

            #layerToggle {
                top: 270px;
                left: 20px;
                position: absolute;
                z-index: 99;
                padding: 10px;
            }

            #layerToggle2 {
                top: 270px;
                left: 120px;
                position: absolute;
                z-index: 99;
                padding: 10px;
            }

            #layerToggle3 {
                top: 320px;
                left: 20px;
                position: absolute;
                z-index: 99;
                padding: 10px;
            }

            #layerToggle4 {
                top:320px;
                left: 154px;
                position: absolute;
                z-index: 99;
                padding: 10px;
            }

            #editorBox {
                top: 390px;
                left: 20px;
                position: absolute;
                z-index: 99;
                width: 360px;
                /* height: 400px; */
            }

            /* #buttonTest {
                top: 470px;
                left: 20 px;
                position: absolute;
                z-index: 99;
                padding: 10px;
            } */

          
        </style>

        <!-- JS IN A SCRIPT TAG-->
        <script>
            // REQUIRE STATEMENT LOADS INDIVIDUAL ESRI MODULES
            require(
                [
                    // MAP AND MAPVIEW
                    "esri/config",
                    "esri/Map",
                    "esri/views/MapView",
                    "esri/Basemap",

                    // LAYERS
                    "esri/layers/FeatureLayer",
                    "esri/layers/TileLayer",
                    "esri/layers/WMTSLayer",
                                        
                    // WIDGETS
                    "esri/widgets/Editor",
                ],

                //LOAD MODULES INTO FUNCTION FOR USE IN THE APP
                function(esriConfig, Map, MapView, Basemap, FeatureLayer, TileLayer, WMTSLayer, Editor) {

                // HAVE TO HAVE API KEY TO ACCESS ARCGIS SERVICES
                esriConfig.apiKey = "AAPK47940bdbad24479c8e5cfc3285632cf0D6SI_0gce6ZC0zx7iGkSeVP7k66w2b23CD8OKRR1jRMFulXcBwmgjXjgUHmhXMNS";

                // CREATE WMTS BASEMAP FOR TEXAS 6 INCH IMAGERY
                const TISBasemap = new Basemap({
                    baseLayers: [
                        new WMTSLayer({
                            url: "https://txgi.tnris.org/login/path/food-paul-zebra-shirt/wmts/1.0.0/WMTSCapabilities.xml",
                            activeLayer: {
                                id: "texas"
                            }
                        })  
                    ]
                });

                //CREATE MAP WITH IMAGERY BASEMAP
                const map = new Map({
                    basemap : TISBasemap 
                });

                // CREATE MAPVIEW
                const mapView = new MapView({
                    map: map,
                    center: [-100.341389, 31.132222],
                    zoom: 6,
                    container: "viewDiv",
                    padding: {
                        left: 400 
                    }
                });

                // CONSTRUCT FEATURELAYERS

                //ROADWAYS
                const roadways = new FeatureLayer({
                    url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0",
                    id: "roadways",
                    visible: false
                });

                // BRIDGES RENDERER AND LAYER
                const bridgesRenderer = {
                    type: "simple",
                    symbol: {
                        type: "simple-fill",
                        style: "solid",
                        color: "#73B2FF",
                        outline: {
                            color: "#5E5E5E",
                            width: 1
                        }
                    }
                };
                const bridgeTest = new FeatureLayer({
                    url: "https://services1.arcgis.com/7DRakJXKPEhwv0fM/arcgis/rest/services/bridgehull_testcopy/FeatureServer/0",
                    renderer: bridgesRenderer,
                    opacity: 0.5,
                    definitionExpression: "IS_IRREG IS NULL"
                });

                // STREAMS
                const streams = new FeatureLayer ({
                    url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Streams/FeatureServer",
                    id: "streams",
                    visible: false
                });


                // RAIL ROADS RENDERER (SYMBOLOGY) AND RAIL ROADS LAYER
                const railroadsRenderer = {
                    type: "simple",
                    symbol: {
                        color: "#964B00",
                        type: "simple-line",
                        style: "solid",
                        width: 1.5
                    },
                };
                const railroads = new FeatureLayer ({
                    url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Railroads/FeatureServer",
                    renderer: railroadsRenderer,
                    id: "railroads",
                    visible: false
                });

                  
                // BRIDGE POINTS
                const nbiRenderer = {
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: "red"
                    }
                };
                const nbiPoints = new FeatureLayer ({
                    url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer",
                    renderer: nbiRenderer,
                    id: "nbiPoints", 
                    visible: false
                });

                // ADD FEATURELAYERS TO THE MAP
                map.addMany([roadways, bridgeTest, streams, railroads, nbiPoints]);

                // CREATE VARIABLE REFERENCING THE CHECKBOX NODE 
                const streamsLayerToggle = document.getElementById("streams");
                const roadwaysLayerToggle = document.getElementById("roadways");
                const nbiLayerToggle = document.getElementById("nbiPoints");
                const railroadsLayerToggle = document.getElementById("railroads");

                // LISTEN TO THE CHANGE EVENT FOR THE CHECKBOXS AND CHANGE VISIBILITY
                streamsLayerToggle.addEventListener("change", () => {
                    streams.visible = streamsLayerToggle.checked;
                });
                roadwaysLayerToggle.addEventListener("change", () => {
                    roadways.visible = roadwaysLayerToggle.checked;
                });
                nbiLayerToggle.addEventListener("change", () => {
                    nbiPoints.visible = nbiLayerToggle.checked;
                });
                railroadsLayerToggle.addEventListener("change", () => {
                    railroads.visible = railroadsLayerToggle.checked;
                });
                  

                // const superButton = document.getElementById("superButton");
                // superButton.addEventListener("click", () => {
                //     console.log(bridgeTest.id)
                // });



                // SET UP EDITABLE LAYERS FOR EDITOR WIDGET
                mapView.map.editableLayers.forEach((layer) => {
                    if (layer.type === 'feature') {
                        switch (layer.geometryType) {
                            case "polygon":
                                polygonLayer = layer;
                                break;
                            case "polyline":
                                lineLayer = layer;
                                break;
                            case "point":
                                pointLayer = layer;
                                break;
                        }
                    }
                });

                // SET BRIDGE LAYER'S LAYERINFO
                const bridgeInfos = {
                    layer: bridgeTest,
                    formTemplate: { // AUTOCASTS TO FORMTEMPLATE
                        elements: [{ // AUTOCASTS TO FIELD ELEMENTS
                            type: "field",
                            fieldName: "IS_IRREG",
                            label: "Is Irregular"
                        }, {
                            type: "field",
                            fieldName: "IRREG_RSN",
                            label: "Irregular Reason"
                        }, {
                            type: "field",
                            fieldName: "COMMENT",
                            label: "Comment"
                        }]
                    }
                };

                // EDITOR WIDGET
                const editor = new Editor({
                    view: mapView,
                    layerInfos: [bridgeInfos],
                    container: editorBox
                });

                // ADD WIDGET TO THE VIEW
                //mapView.ui.add(editor, "bottom-left");


                // CREATE QUERY TO ONLY SEE THE REMAINING BRIDGES
                let queryNull = bridgeTest.createQuery();
                queryNull.where = "IS_IRREG IS NULL";
                queryNull.returnGeometry = true;
                queryNull.outFields = ["*"];
                queryNull.num = 2000; //to pull from next 2000
        
                
                // LOAD MAP AND FIND REFERENCE
                mapView
                    .when(() => {
                        findBridge();
                        // console.log("this message shows when it is loaded.");
                    })

                function findBridge() {
                    bridgeTest.queryFeatures(query)
                        .then(function(featureSet) {
                            // console.log("layer queried");
                            // console.log("featureSet", featureSet);
                            // console.log(featureSet.features.length);
                            showSelectedResult (featureSet);
                        });
                }
                
                // FIND REFERENCE FUNCTION
                // function findReference() {
                //     document.getElementById("theOutput").innerHTML = "Searching for segment...";
                //     referencePoints.queryFeatures(query)
                //         .then(showSelectedResult(response),{
                //             // NOT SURE WHAT TO DO WITH THIS YET
                //         }); 
                // }

                // function showSelectedResult (results) {
                //     var resultItems = [];
                //     var resultCount = results.features.length;
                    
                //     if (resultCount<1) {
                //         alert("All records have been QCed. Project Complete.");
                //         return;
                //     }
                    
                //     var arrayID = getRandomIntInclusive(0,resultCount-1);
                //     var featureAttributes = results.features[arrayID].attributes;
                //     zoomToCoordinate(featureAttributes.LONGITUDE,featureAttributes.LATITUDE); 
                //     map.setZoom(featureAttributes.MAP_LEVEL); 
                //     // theRecordID = featureAttributes.OBJECTID;
                //     // theRTE_NM = featureAttributes.RTE_RB_NM;
                //     // document.getElementById("debugDiv").innerHTML = "Map ID = " + theRecordID + " - Highway = " + theRTE_NM;
                    
                //     if (resultCount>0) {
                //         //Clear searching message
                //         document.getElementById("theOutput").innerHTML = "";
                //     }
                //     else {
                //         findReference();
                //     }
                // }

                // function zoomToCoordinate(theX,theY,theZ) {
  	            //     var thePt = new esri.geometry.Point(theX,theY, new esri.SpatialReference({ wkid: 4269 }));
  	            //     map.centerAndZoom(esri.geometry.geographicToWebMercator(thePt),map.getZoom());
  	            // } 

                // TESTING BUTTON 

                // const testbtn = document.createElement("button");
                // testbtn.innerText = "Test Button";
                // mapView.ui.add(testbtn, "top-right");
                // testbtn.addEventListener("click", () => {
                //     console.log("clicked");
                // })


            });

        </script>
    </head>

    <!--- AFTER THE HEAD COMES THE BODY WITHIN THE HTML BRACES-->
    <body>
        <div id="viewDiv">
            <div id="sidebar" class="esri-widget">
                <div id="text">
                    <h1> INSTRUCTIONS </h1>
                    <P>
                        <li> The instructions will go here. </li>
                        <li> Even more instructions will go here. </li>
                        <li> Do your best, and have fun. :p </li>
                    </P>
                </div>
                <div id="text">
                    <h1>TOGGLE LAYERS</h1>
                    <p>
                        Use the checkboxes below to toggle reference layers on and off.
                    </p>
                </div>
                <div id="layerToggle" class="esri-widget"> <input type="checkbox" id="streams" unchecked /> Streams </div>
                <div id="layerToggle2" class="esri-widget"> <input type="checkbox" id="roadways" unchecked /> Roadways </div>
                <div id="layerToggle3" class="esri-widget"> <input type="checkbox" id="nbiPoints" unchecked /> Bridge Points </div>
                <span id="layerToggle4" class="esri-widget"> <input type="checkbox" id="railroads" unchecked /> Railroads </span>
                <!-- <button id = "superButton"> Click Me! </button> -->
                <div id="editorBox"></div>
            </div>
        </div>
    </body>
</html>

